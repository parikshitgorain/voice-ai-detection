version: '3.8'

services:
  # Main application with GPU support
  voice-ai-detection:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        USE_GPU: "true"
        PYTORCH_INDEX_URL: "https://download.pytorch.org/whl/cu121"
    image: voice-ai-detection:latest
    container_name: voice-ai-detection
    restart: unless-stopped
    
    # GPU configuration (optional, will fall back to CPU if unavailable)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    
    ports:
      - "3000:3000"
    
    environment:
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=3000
      - DEEP_MODEL_DEVICE=auto  # auto-detect GPU/CPU
      - VOICE_DETECT_API_KEY=${VOICE_DETECT_API_KEY:-your-secret-key}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - DEEP_MODEL_PATH_ENGLISH=/app/backend/deep/multitask_English.pt
      - DEEP_MODEL_PATH_HINDI=/app/backend/deep/multitask_Hindi.pt
      - DEEP_MODEL_PATH_TAMIL=/app/backend/deep/multitask_Tamil.pt
      - DEEP_MODEL_PATH_MALAYALAM=/app/backend/deep/multitask_Malayalam.pt
      - DEEP_MODEL_PATH_TELUGU=/app/backend/deep/multitask_Telugu.pt
      - QUEUE_MAX_CONCURRENT=3
      - QUEUE_MAX_LENGTH=10
    
    volumes:
      # Persist logs and data
      - ./backend/logs:/app/backend/logs
      - ./backend/data:/app/backend/data
      # Mount models (comment out if models are in image)
      - ./backend/deep/multitask_English.pt:/app/backend/deep/multitask_English.pt:ro
      - ./backend/deep/multitask_Hindi.pt:/app/backend/deep/multitask_Hindi.pt:ro
      - ./backend/deep/multitask_Tamil.pt:/app/backend/deep/multitask_Tamil.pt:ro
      - ./backend/deep/multitask_Malayalam.pt:/app/backend/deep/multitask_Malayalam.pt:ro
      - ./backend/deep/multitask_Telugu.pt:/app/backend/deep/multitask_Telugu.pt:ro
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    networks:
      - voice-ai-network

networks:
  voice-ai-network:
    driver: bridge
