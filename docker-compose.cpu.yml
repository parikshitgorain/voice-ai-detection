version: '3.8'

# CPU-only version (no GPU support)
# Use this for VPS without GPU

services:
  voice-ai-detection-cpu:
    build:
      context: .
      dockerfile: Dockerfile.cpu
    image: voice-ai-detection:cpu
    container_name: voice-ai-detection-cpu
    restart: unless-stopped
    
    ports:
      - "3000:3000"
    
    environment:
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=3000
      - DEEP_MODEL_DEVICE=cpu
      - VOICE_DETECT_API_KEY=${VOICE_DETECT_API_KEY:-your-secret-key}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - DEEP_MODEL_PATH_ENGLISH=/app/backend/deep/multitask_English.pt
      - DEEP_MODEL_PATH_HINDI=/app/backend/deep/multitask_Hindi.pt
      - DEEP_MODEL_PATH_TAMIL=/app/backend/deep/multitask_Tamil.pt
      - DEEP_MODEL_PATH_MALAYALAM=/app/backend/deep/multitask_Malayalam.pt
      - DEEP_MODEL_PATH_TELUGU=/app/backend/deep/multitask_Telugu.pt
      - QUEUE_MAX_CONCURRENT=3
      - QUEUE_MAX_LENGTH=10
    
    volumes:
      - ./backend/logs:/app/backend/logs
      - ./backend/data:/app/backend/data
      - ./backend/deep/multitask_English.pt:/app/backend/deep/multitask_English.pt:ro
      - ./backend/deep/multitask_Hindi.pt:/app/backend/deep/multitask_Hindi.pt:ro
      - ./backend/deep/multitask_Tamil.pt:/app/backend/deep/multitask_Tamil.pt:ro
      - ./backend/deep/multitask_Malayalam.pt:/app/backend/deep/multitask_Malayalam.pt:ro
      - ./backend/deep/multitask_Telugu.pt:/app/backend/deep/multitask_Telugu.pt:ro
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    networks:
      - voice-ai-network

networks:
  voice-ai-network:
    driver: bridge
